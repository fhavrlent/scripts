#!/bin/bash
set -euo pipefail

# ==================================================================
# ROOT
# ==================================================================

cd ~
mkdir -p repos

# ==================================================================
# SSH KEY
# ==================================================================

echo "Generating ssh keys, adding to ssh-agent..."
read -p 'Input email for ssh key: ' useremail

echo "Use default ssh file location, enter a passphrase: "
ssh-keygen -t rsa -b 4096 -C "$useremail"  # will prompt for password
eval "$(ssh-agent -s)"

# Now that sshconfig is synced add key to ssh-agent and
# store passphrase in keychain
ssh-add -K ~/.ssh/id_rsa

if [ -e ~/.ssh/config ]
then
    echo "ssh config already exists. Skipping adding osx specific settings... "
else
	echo "Writing osx specific settings to ssh config... "
   cat <<EOT >> ~/.ssh/config
	Host *
		AddKeysToAgent yes
		UseKeychain yes
		IdentityFile ~/.ssh/id_rsa
EOT
fi

# ==================================================================
# PACKAGES
# ==================================================================

echo "Installing Homebrew"
/usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
brew upgrade
brew update

echo "Adding Homebrew taps"

homebrew_taps=(
	"caskroom/cask"
  "caskroom/fonts"
)

for homebrew_tap in "${homebrew_taps[@]}"; do
	brew tap "$homebrew_tap"
done

echo "Installing global Homebrew packages"

homebrew_packages=(
	"rclone"
  "git"
  "mas"
  "yarn"
  "tig"
  "zsh" 
  "zsh-completions"
)

for homebrew_package in "${homebrew_packages[@]}"; do
  brew install "$homebrew_package"
done

echo "Installing Node version manager"
curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.33.11/install.sh | bash

echo "Installing Node"
. ~/.nvm/nvm.sh
nvm install --lts
nvm use --lts

echo "Upgrading npm"
npm install -g npm

echo "Installing npm packages"

npm_packages=(
  "create-react-app"
)

for npm_package in "${npm_packages[@]}"; do
  npm install -g "$npm_package"
done


# ==================================================================
# APPS 
# ==================================================================

echo "Installing Homebrew cask apps and fonts"

homebrew_cask_packages=(
  "arq"
  "cold-turkey-blocker"
  "docker"
  "font-fira-code"
  "font-meslo-for-powerline"
  "google-chrome"
  "gpg-suite"
  "iterm2"
  "postman"
  "scroll-reverser"
  "slack"
  "spotify"
  "virtualbox"
  "visual-studio-code"
  "vlc"
  "whatsapp"
  "notion"
  "microsoft-teams"
  
)

for homebrew_cask_package in "${homebrew_cask_packages[@]}"; do
  brew cask install "$homebrew_cask_package"
done

brew cleanup

echo "Installing Mac App Store apps"

mac_app_store_apps=(
  "585829637" # Todoist
  "836505650" # Battery Monitor
  "931134707" # Wire
  "568494494" # Pocket
  "732710998" # Enpass
)
for mac_app_store_app in "${mac_app_store_apps[@]}"; do
  mas install "$mac_app_store_app"
done

# ==================================================================
# VS Code
# ==================================================================

echo "Setting up VS Code"

cat << EOF >> ~/.bash_profile
# Add Visual Studio Code (code)
export PATH="$PATH:/Applications/Visual Studio Code.app/Contents/Resources/app/bin"
EOF

vscode_extensions=("Compulim.vscode-clock"
"amatiasq.sort-imports"
"capaj.vscode-exports-autocomplete"
"christian-kohler.path-intellisense"
"dbaeumer.vscode-eslint"
"eamodio.gitlens"
"EditorConfig.EditorConfig"
"eg2.tslint"
"esbenp.prettier-vscode"
"kumar-harsh.graphql-for-vscode"
"ms-vsliveshare.vsliveshare"
"naumovs.color-highlight"
"octref.vetur"
"robertohuertasm.vscode-icons")

for vscode_extension in "${vscode_extensions[@]}"; do
  code --install-extension "$vscode_extension"
done


# ==================================================================
# REPOS
# ==================================================================

cd ~/repos

echo "Cloning scripts"
git clone git@github.com:fhavrlent/scripts.git

echo "Cloning dotfiles"
git clone git@github.com:fhavrlent/dotfiles.git


# ==================================================================
# DOTFILES
# ==================================================================

cd ~/repos/dotfiles

echo "VS Code dotfiles"
rm -f ~/Library/Application\ Support/Code/User/settings.json
ln ./vscode.json ~/Library/Application\ Support/Code/User/settings.json



# ==================================================================
# MACOS
# ==================================================================

# SCREENSHOTS

echo "Configuring screenshots to save in Downloads"
defaults write com.apple.screencapture location ~/Downloads
killall SystemUIServer


# DS_STORE

echo "Turning off .DS_Store on network drives"
defaults write com.apple.desktopservices DSDontWriteNetworkStores true

# Minimize windows into their applicationâ€™s icon
defaults write com.apple.dock minimize-to-application -bool true

# Disable auto-correct
defaults write NSGlobalDomain NSAutomaticSpellingCorrectionEnabled -bool false

# Require password immediately after sleep or screen saver begins"
defaults write com.apple.screensaver askForPassword -int 1
defaults write com.apple.screensaver askForPasswordDelay -int 0

# Enable the automatic update check
defaults write com.apple.SoftwareUpdate AutomaticCheckEnabled -bool true

# Download newly available updates in background
defaults write com.apple.SoftwareUpdate AutomaticDownload -int 1

# Install System data files & security updates
defaults write com.apple.SoftwareUpdate CriticalUpdateInstall -int 1

# ==================================================================
# oh-my-zsh
# ==================================================================

echo "Setting up oh-my-zsh"
sh -c "$(curl -fsSL https://raw.github.com/robbyrussell/oh-my-zsh/master/tools/install.sh)"
echo "zsh dotfiles"
rm -f ~/.zshrc
ln .zshrc ~/.zshrc
source ~/.zshrc

cd ~
